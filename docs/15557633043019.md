第五章 与HTTP协作的Web服务器

[TOC]

##5.1 用单台虚拟主机实现多个域名
域名通过DNS服务映射到IP地址后，访问目标网站，当请求发送到服务器时，已经是以IP地址的形式访问了。多个域名对应同一个IP。
在相同的IP地址下，由于虚拟主机可以寄存多个不同主机名和域名的Web网站，因此在发送HTTP请求时，必须在Host首部内完整指定主机名或域名的URI。

##5.2 通信数据转发程序：代理、网关、隧道
这些应用和服务器可以将请求转发下一站服务器，并且接收该服务器发送的响应再转发给客户端。
代理：代理是一种有转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端。（相同协议，如：HTTP，版本可以不同）

网关：网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。（不同协议，如：客户端 --HTTP---> 网关 --POP---> 邮箱服务器）

隧道：隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。（HTTP应用程序发送非HTTP的流量）

##5.2.1 代理
在客户端和源服务器之间可以多级代理，每次通过代理服务器转发请求或响应时，会追加Via首部信息以标记出经过的主机信息。

via格式：(协议名) (协议版本) 节点名 (节点注释)，括号内为可选项
    节点名：处于隐私的原因，可被隐藏，修改为假名替换

代理的用途：
过滤器：过滤掉某些IP的访问
文档访问控制：限制某些文档的访问
安全防火墙：阻止SQL注入、阻止OS注入等（Nginx + lua）
Web缓存：响应存入本地，不需要重复获取。
反向代理：接收真实请求，转发给内部网络上的服务器。
负载均衡：根据网络流量状况把请求导向给特定的服务器。
转码器：修改内容的主体格式，如：传输gif时，转换成jpeg。
匿名者：删除身份特征（如：cookie、Ip），从而提供高度私密性。


代理的使用方法：
缓存代理：代理转发响应时，缓存代理会预先将资源的副本保存在代理服务器上。当代理再次接收到对相同资源的请求时，就可以将之前缓存的资源作为响应返回，而无需再次访问源服务器。
透明代理和非透明代理：转发请求和响应时，是否对报文做加工，不加工的是透明代理。

代理服务器部署

正向代理（出口代理）：客户端 -> 内网 -> 代理 -> 外网 -> 服务器，如：VPN
反向代理（入口代理）：客户端 -> 外网 -> 代理 -> 内网 -> 服务器，如：防火墙
网络交换代理：客户端 -> 外网 -> 代理 -> 外网 -> 服务器，如：缓存服务器

###5.2.2 网关
利用网关可以由HTTP请求转化为其他协议通信。网关和代理类似，但能使通信线路上的服务器提供非HTTP协议服务。

常见的网关
协议网关：如客户端 --HTTP--> 网关 --FTP--> ftp服务器
资源网关：CGI（通用网关接口）

协议网关
（1）HTTP/*网关：HTTP ->其他协议的网关
注：常见的有HTTP/TCP，即外部使用Rest API，内部使用RPC(可为TCP)
（2）HTTPS/HTTP网关：HTTPS->HTTP的网关
外网使用HTTPS保证安全，内部使用HTTP保证高效。

资源网关：CGI
CGI是一个标准接口集，Web服务器用它来装载程序以响应特定URL的HTTP请求，并收集程序的输出数据，将其放在HTTP响应中回送。
    起初CGI为每个请求建立一个进程，处理完成后销毁，后面这个开销太大，出现了快速CGI。
    快速CGI启动一个守护进程，并且使用开销更小的线程来代替进程去处理请求。

###5.2.3 隧道
隧道可按要求建立起一条与其他服务器的通信线路，届时可以使用SSL等加密手段进行通信。隧道的目的是确保客户端能与服务端进行安全的通信。
通过隧道的传输可以和远距离的服务器安全通信。隧道本身是透明的，客户端不用在意隧道的存在。

1 概述
隧道使得HTTP应用程序可以发送非HTTP流量
用于穿透只允许Web流量通过的防火墙


2 建立连接的过程
请求报文
CONNECT server.example.com:80 HTTP/1.1
Host: server.example.com:80

响应报文
HTTP1.1 200 Connection Established

3 SSL隧道
![](https://img2018.cnblogs.com/blog/1136599/201811/1136599-20181126155059853-2028912934.png)

##5.3 保存资源的缓存
缓存服务器是代理服务器的一种。
###5.3.1 缓存的有效期
源服务器上的资源可能会被更新
即使有缓存，也会因客户端的要求、缓存有效期等因素，向源服务器确认资源的有效性。若判断失效，缓存服务器将会再次从源服务器上获取新的资源。

###5.3.2 客户端的缓存
缓存不仅可以存在缓存服务器，也可以存在客户端浏览器中。
浏览器缓存如果有效，就不必在向服务器请求相同资源，直接可以从本地磁盘内读取。
和缓存服务器相同的一点，当判定缓存失效时，浏览器会再次请求资源。






>参考：https://www.cnblogs.com/linzhanfly/p/10020769.html