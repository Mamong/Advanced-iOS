APPå¯åŠ¨æ—¶é—´ä¼˜åŒ–

[TOC]

##å¯åŠ¨æ–¹å¼
APPä¸€èˆ¬åˆ†ä¸ºçƒ­å¯åŠ¨å’Œå†·å¯åŠ¨

å†·å¯åŠ¨æ˜¯æŒ‡APPç‚¹å‡»å¯åŠ¨å‰ï¼Œå®ƒçš„è¿›ç¨‹ä¸åœ¨ç³»ç»Ÿé‡Œï¼Œéœ€è¦ç³»ç»Ÿåˆ›å»ºæ–°çš„è¿›ç¨‹åˆ†é…ç»™å®ƒå¯åŠ¨ï¼Œè¿™æ˜¯ä¸€æ¬¡å®Œæˆçš„å¯åŠ¨è¿‡ç¨‹ã€‚

ä¸€èˆ¬æ¥è¯´å¯åŠ¨æ—¶é—´ï¼ˆç‚¹å‡»å›¾æ ‡ -> æ˜¾ç¤ºLaunch Screen -> Launch Screenæ¶ˆå¤±ï¼‰åœ¨å°äº400msæ˜¯æœ€ä½³çš„ï¼Œå¹¶ä¸”ç³»ç»Ÿé™åˆ¶äº†å¯åŠ¨æ—¶é—´ä¸å¯ä»¥å¤§äº20sï¼Œå¦åˆ™ä¼šå› ä¸ºwatchdog(çœ‹é—¨ç‹—)æœºåˆ¶è¢«æ€æ‰ã€‚
åœ¨ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œè¶…æ—¶æ—¶é—´çš„é™åˆ¶ä¼šæœ‰æ‰€å·®åˆ«ï¼š

|ç”Ÿå‘½å‘¨æœŸ|è¶…æ—¶æ—¶é—´|
|----|----|
|å¯åŠ¨ Launch|20 s|
|æ¢å¤ Resume|10 s|
|æ‚¬æŒ‚ Suspend|10 s|
|é€€å‡º Quit|6 s|
|åå° Background|10 min|


çƒ­å¯åŠ¨æ˜¯æŒ‡APPåœ¨å†·å¯åŠ¨ä¹‹åç”¨æˆ·å°†APPé€€å‡ºï¼ŒæŒ‚åœ¨åå°ï¼Œæ­¤æ—¶å®ƒçš„è¿›ç¨‹è¿˜æ˜¯å­˜åœ¨åœ¨ç³»ç»Ÿçš„è¿›ç¨‹é‡Œï¼Œç”¨æˆ·åœ¨æ­¤å¯åŠ¨éœ€è¦çš„æ—¶é—´æ¯”è¾ƒå°‘ï¼Œå¯ä»¥åšçš„äº‹æƒ…ä¸å¤šã€‚

è¿™é‡Œåªåšå†·å¯åŠ¨çš„ä¼˜åŒ–ã€‚

é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“Appåœ¨å¯åŠ¨æ—¶éƒ½å¹²äº†äº›ä»€ä¹ˆäº‹ï¼Œæ‰èƒ½æœ‰é’ˆå¯¹çš„è¿›è¡Œä¼˜åŒ–ã€‚ Appçš„å¯åŠ¨å¯ä»¥å½’çº³ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

* mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œå‰
* mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œå
* é¦–å±æ¸²æŸ“å®Œæˆ

##mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œå‰
åœ¨mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œå‰ï¼Œç³»ç»Ÿä¸»è¦ä¼šåšä»¥ä¸‹å‡ ä»¶äº‹ï¼š
![](https://user-gold-cdn.xitu.io/2019/7/22/16c18f6be0913af0?imageView2/0/w/1280/h/960/ignore-error/1)

###Load dylibs

Dyldä»ä¸»æ‰§è¡Œæ–‡ä»¶çš„headerè·å–éœ€è¦åŠ è½½çš„æ‰€ä¾èµ–åŠ¨æ€åº“åˆ—è¡¨ï¼Œç„¶åå®ƒæ‰¾åˆ°æ¯ä¸ªdylibï¼Œè€Œåº”ç”¨æ‰€ä¾èµ–çš„ dylib æ–‡ä»¶å¯èƒ½ä¼šå†ä¾èµ–å…¶ä»– dylibï¼Œæ‰€ä»¥æ‰€éœ€è¦åŠ è½½çš„æ˜¯åŠ¨æ€åº“åˆ—è¡¨ä¸€ä¸ªé€’å½’ä¾èµ–çš„é›†åˆã€‚

ä¼˜åŒ–ï¼š
1.å°½é‡ä¸ä½¿ç”¨å†…åµŒï¼ˆembeddedï¼‰çš„dylibï¼ŒåŠ è½½å†…åµŒdylibæ€§èƒ½å¼€é”€è¾ƒå¤§ï¼›
2.åˆå¹¶å·²æœ‰çš„dylibå’Œä½¿ç”¨é™æ€åº“ï¼ˆstatic archivesï¼‰ï¼Œå‡å°‘dylibçš„ä½¿ç”¨ä¸ªæ•°ï¼›
3.æ‡’åŠ è½½dylibï¼Œä½†æ˜¯è¦æ³¨æ„dlopen()å¯èƒ½é€ æˆä¸€äº›é—®é¢˜ï¼Œä¸”å®é™…ä¸Šæ‡’åŠ è½½åšçš„å·¥ä½œä¼šæ›´å¤š

###Rebaseå’ŒBind
1. Rebaseåœ¨Imageå†…éƒ¨è°ƒæ•´æŒ‡é’ˆçš„æŒ‡å‘ã€‚åœ¨è¿‡å»ï¼Œä¼šæŠŠåŠ¨æ€åº“åŠ è½½åˆ°æŒ‡å®šåœ°å€ï¼Œæ‰€æœ‰æŒ‡é’ˆå’Œæ•°æ®å¯¹äºä»£ç éƒ½æ˜¯å¯¹çš„ï¼Œè€Œç°åœ¨åœ°å€ç©ºé—´å¸ƒå±€æ˜¯éšæœºåŒ–ï¼Œæ‰€ä»¥éœ€è¦åœ¨åŸæ¥çš„åœ°å€æ ¹æ®éšæœºçš„åç§»é‡åšä¸€ä¸‹ä¿®æ­£ã€‚
2. Bindæ˜¯æŠŠæŒ‡é’ˆæ­£ç¡®åœ°æŒ‡å‘Imageå¤–éƒ¨çš„å†…å®¹ã€‚è¿™äº›æŒ‡å‘å¤–éƒ¨çš„æŒ‡é’ˆè¢«ç¬¦å·(symbol)åç§°ç»‘å®šï¼Œdyldéœ€è¦å»ç¬¦å·è¡¨é‡ŒæŸ¥æ‰¾ï¼Œæ‰¾åˆ°symbolå¯¹åº”çš„å®ç°

ä¼˜åŒ–:
1.å‡å°‘ObjCç±»ï¼ˆclassï¼‰ã€æ–¹æ³•ï¼ˆselectorï¼‰ã€åˆ†ç±»ï¼ˆcategoryï¼‰çš„æ•°é‡ï¼›2.å‡å°‘C++è™šå‡½æ•°çš„çš„æ•°é‡ï¼ˆåˆ›å»ºè™šå‡½æ•°è¡¨æœ‰å¼€é”€ï¼‰ï¼›
3.ä½¿ç”¨Swift structsï¼ˆå†…éƒ¨åšäº†ä¼˜åŒ–ï¼Œç¬¦å·æ•°é‡æ›´å°‘ï¼‰

###Objc setup
1.æ³¨å†ŒObjcç±» (class registration)ï¼›2.æŠŠcategoryçš„å®šä¹‰æ’å…¥æ–¹æ³•åˆ—è¡¨ (category registration)ï¼›
3.ä¿è¯æ¯ä¸€ä¸ªselectorå”¯ä¸€ (selector uniquing)

ä¼˜åŒ–ï¼š
å‡å°‘ Objective-C Classã€Selectorã€Category çš„æ•°é‡ï¼Œå¯ä»¥åˆå¹¶æˆ–è€…åˆ å‡ä¸€äº›OCç±»
###Initializers
1.Objcçš„+load()å‡½æ•°ï¼›
2.C++çš„attribute((constructor))å‡½æ•°ï¼›
3.éåŸºæœ¬ç±»å‹çš„C++é™æ€å…¨å±€å˜é‡çš„åˆ›å»º(é€šå¸¸æ˜¯ç±»æˆ–ç»“æ„ä½“)

ä¼˜åŒ–ï¼š
1.å°‘åœ¨ç±»çš„+loadæ–¹æ³•é‡Œåšäº‹æƒ…ï¼Œå°½é‡æŠŠè¿™äº›äº‹æƒ…æ¨è¿Ÿåˆ°+initiailizeï¼Œæˆ–æ”¾åœ¨é¦–å±æ¸²æŸ“å®Œæˆååœ¨å»å¤„ç†ï¼›
2.å‡å°‘æ„é€ å™¨å‡½æ•°ä¸ªæ•°ï¼Œåœ¨æ„é€ å™¨å‡½æ•°é‡Œå°‘åšäº›äº‹æƒ…ï¼›
3.å‡å°‘C++é™æ€å…¨å±€å˜é‡çš„ä¸ªæ•°

###å¯åŠ¨æ—¶é—´çš„æµ‹é‡
####Xcodeæä¾›çš„ç»Ÿè®¡
å¯¹äºpre-mainé˜¶æ®µï¼ŒXcodeæä¾›äº†å„ä¸ªé˜¶æ®µæ—¶é—´æ¶ˆè€—çš„æ–¹æ³•ï¼Œ Product -> Scheme -> Edit Scheme -> Environment Variables ä¸­å°†ç¯å¢ƒå˜é‡ DYLD_PRINT_STATISTICSè®¾ä¸º1;

```
Total pre-main time: 955.81 milliseconds (100.0%)
         dylib loading time:  97.42 milliseconds (10.1%)
        rebase/binding time:  55.08 milliseconds (5.7%)
            ObjC setup time:  68.65 milliseconds (7.1%)
           initializer time: 734.45 milliseconds (76.8%)
           slowest intializers :
             libSystem.B.dylib :   7.65 milliseconds (0.8%)
    libMainThreadChecker.dylib :  36.33 milliseconds (3.8%)
                              ...
```
è¿™é‡Œé¢å¤–è¡¥å……ä¸€ä¸‹å…¶ä»–çš„dyldç¯å¢ƒå˜é‡å‚æ•°ï¼š

|å˜é‡|æè¿°|
|----|----|
|DYLD_PRINT_STATISTICS_DETAILS|æ‰“å°å¯åŠ¨æ—¶é—´ç­‰è¯¦ç»†å‚æ•°|
|DYLD_PRINT_SEGMENTS|æ‰“å°segmentæ˜ å°„æ—¥å¿—|
|DYLD_PRINT_INITIALIZERS|Log image initialization callsæ‰“å°é•œåƒåˆå§‹åŒ–è°ƒç”¨æ—¥å¿—|
|DYLD_PRINT_BINDINGS|æ‰“å°ç¬¦å·ç»‘å®šæ—¥å¿—|
|DYLD_PRINT_APIS|æ‰“å° dyld API è°ƒç”¨æ—¥å¿—|
|DYLD_PRINT_ENV|æ‰“å°å¯åŠ¨ç¯å¢ƒå˜é‡|
|DYLD_PRINT_OPTS|æ‰“å°å¯åŠ¨æ—¶å‘½ä»¤è¡Œå‚æ•°|
|DYLD_PRINT_LIBRARIES_POST_LAUNCH|æ‰“å°åº“åŠ è½½ï¼Œä½†ä»…åœ¨mainè¿è¡Œä¹‹å|
|DYLD_PRINT_LIBRARIES|æ‰“å°åº“åŠ è½½|
|DYLD_IMAGE_SUFFIX|æœç´¢å¸¦æœ‰è¿™ä¸ªåç¼€çš„åº“|

è¿™ä¸ªæ–¹æ³•ç¡®å®å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æˆ‘ä»¬å¦‚æœæƒ³è¦è‡ªå·±åº¦é‡per-mainé˜¶æ®µçš„æ—¶é—´æ¶ˆè€—ï¼Œåˆå¦‚ä½•ç»Ÿè®¡å‘¢ï¼Ÿ 

####å…¶ä»–å·¥å…·
ç”±äºæˆ‘ä»¬ä¸»è¦é’ˆå¯¹å†·å¯åŠ¨è¿›è¡Œä¼˜åŒ–ï¼Œå°±å…ˆä»‹ç»ä¸€ä¸‹å†·å¯åŠ¨çš„æµç¨‹ï¼š 
![](https://user-gold-cdn.xitu.io/2019/7/22/16c18f6c231a229d?imageView2/0/w/1280/h/960/ignore-error/1)
å¯ä»¥å°†å…¶å½’çº³ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š
1. dyldï¼šåŠ è½½é•œåƒï¼ŒåŠ¨æ€åº“
2. RunTimeæ–¹æ³•
3. mainå‡½æ•°åˆå§‹åŒ–

ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºå¼€å‘è€…åœ¨mainä¹‹å‰å¯ä»¥å¤„ç†çš„æ˜¯Run Image Initializersé˜¶æ®µï¼ˆå¯¹åº”Appleå±•ç¤ºå›¾ä¸­çš„initializersé˜¶æ®µï¼‰ï¼ŒloadåŠ è½½ã€__attribute__((constructor))å’ŒC++é™æ€å¯¹è±¡åˆå§‹åŒ–;

#####loadè€—æ—¶ç›‘æµ‹

æƒ³çŸ¥é“loadæ–¹æ³•æ‰§è¡Œçš„æ—¶é—´ï¼Œå°±ä¸å¯é¿å…çš„éœ€è¦è·å–+loadç±»å’Œåˆ†ç±»çš„æ–¹æ³•ã€‚ç›®å‰æˆ‘äº†è§£åˆ°çš„ä¹Ÿæ˜¯æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡runtime apiï¼Œå»è¯»å–å¯¹åº”é•œåƒä¸‹æ‰€æœ‰ç±»åŠå…¶å…ƒç±»ï¼Œå¹¶é€ä¸ªéå†å…ƒç±»çš„å®ä¾‹æ–¹æ³•ï¼Œå¦‚æœæ–¹æ³•åç§°ä¸ºloadï¼Œåˆ™æ‰§è¡Œhookæ“ä½œï¼Œä»£è¡¨åº“æ˜¯AppStartTimeï¼›ä¸€ç§æ˜¯å’Œ runtimeä¸€æ ·ï¼Œç›´æ¥é€šè¿‡getsectiondataå‡½æ•°ï¼Œè¯»å–ç¼–è¯‘æ—¶æœŸå†™å…¥mach-oæ–‡ä»¶DATAæ®µçš„__objc_nlclslistå’Œ __objc_nlcatlistèŠ‚ï¼Œè¿™ä¸¤èŠ‚åˆ†åˆ«ç”¨æ¥ä¿å­˜no lazy classåˆ—è¡¨å’Œno lazy categoryåˆ—è¡¨ï¼Œæ‰€è°“çš„no lazyç»“æ„ï¼Œå°±æ˜¯å®šä¹‰äº†+loadæ–¹æ³•çš„ç±»æˆ–åˆ†ç±»ï¼Œä»£è¡¨åº“æ˜¯[A4LoadMeasure](https://github.com/tripleCC/Laboratory/tree/master/HookLoadMethods/A4LoadMeasure)ã€‚
å…ˆè¯´ä¸€ä¸‹ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”ç»“æœï¼š
![](https://user-gold-cdn.xitu.io/2019/7/22/16c18f6c23473981?imageView2/0/w/1280/h/960/ignore-error/1)

|åº“ 	|loadè¯¯å·® 	|ç»Ÿè®¡èŒƒå›´|
|----|----|----|
|AppStartTime|100mså·¦å³|ç±»|
|A4LoadMeasure|50mså·¦å³|ç±»å’Œåˆ†ç±»|

ä»æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œå½“ç„¶æˆ‘ä»¬ä¼šé€‰æ‹©åè€…ï¼Œè¿˜ç»Ÿè®¡äº†åˆ†ç±»loadåŠ è½½ã€‚è€Œä¸”ä»æ€§èƒ½ä¸Šçœ‹ï¼Œå‰è€…ä¼šforå¾ªç¯è°ƒç”¨object_getClass()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè§¦å‘ç±»çš„[realize](https://github.com/tripleCC/Laboratory/blob/5c084263d79973805649b89d166b50751045e937/AppleSources/objc4-750/runtime/objc-runtime-new.mm#L1858-L1974) æ“ä½œï¼Œç»™ç±»å¼€è¾Ÿå¯è¯»å†™çš„ä¿¡æ¯å­˜å‚¨ç©ºé—´ã€è°ƒæ•´æˆå‘˜å˜é‡å¸ƒå±€ã€æ’å…¥åˆ†ç±»æ–¹æ³•å±æ€§ç­‰æ“ä½œï¼Œç®€å•æ¥è¯´å°±æ˜¯è®©ç±»å˜æˆå¯ç”¨(realized)çŠ¶æ€ï¼Œè¿™æ ·å½“æœ‰å¤§é‡çš„ç±»è¿›è¡Œè¯¥æ“ä½œæ—¶ï¼Œä¼šé¢å¤–å¢åŠ per-mainæ—¶é—´ï¼Œé€ æˆä¸å¿…è¦çš„å¼€é”€ã€‚
```
//è·å–no lazy class åˆ—è¡¨å’Œ no lazy category åˆ—è¡¨
static NSArray <LMLoadInfo *> *getNoLazyArray(const struct mach_header *mhdr) {
    NSMutableArray *noLazyArray = [NSMutableArray new];
    unsigned long bytes = 0;
    Class *clses = (Class *)getDataSection(mhdr, "__objc_nlclslist", &bytes);
    for (unsigned int i = 0; i < bytes / sizeof(Class); i++) {
        LMLoadInfo *info = [[LMLoadInfo alloc] initWithClass:clses[i]];
        if (!shouldRejectClass(info.clsname)) [noLazyArray addObject:info];
    }
    
    bytes = 0;
    Category *cats = getDataSection(mhdr, "__objc_nlcatlist", &bytes);
    for (unsigned int i = 0; i < bytes / sizeof(Category); i++) {
        LMLoadInfo *info = [[LMLoadInfo alloc] initWithCategory:cats[i]];
        if (!shouldRejectClass(info.clsname)) [noLazyArray addObject:info];
    }
    
    return noLazyArray;
}

//hook ç±»å’Œåˆ†ç±»çš„ +load æ–¹æ³•
static void hookAllLoadMethods(LMLoadInfoWrapper *infoWrapper) {
    unsigned int count = 0;
    Class metaCls = object_getClass(infoWrapper.cls);
    Method *methodList = class_copyMethodList(metaCls, &count);
    for (unsigned int i = 0, j = 0; i < count; i++) {
        Method method = methodList[i];
        SEL sel = method_getName(method);
        const char *name = sel_getName(sel);
        if (!strcmp(name, "load")) {
            LMLoadInfo *info = nil;
            if (j > infoWrapper.infos.count - 1) {
                info = [[LMLoadInfo alloc] initWithClass:infoWrapper.cls];
                [infoWrapper insertLoadInfo:info];
                LMAllLoadNumber++;
            } else {
                info = infoWrapper.infos[j];
            }
            ++j;
            swizzleLoadMethod(infoWrapper.cls, method, info);
        }
    }
    free(methodList);
}

```
Tip: è¿™é‡Œè¯´æ˜ä¸€ä¸ªé—®é¢˜ï¼ŒA4LoadMeasureç”¨LMAllLoadNumberå®šä½æœ€åä¸€æ¬¡æ‰“å°æœ‰è®¡ç®—è¯¯å·®ï¼Œç¨å¾®å–å·§äº†ä¸€ä¸‹ï¼Œæ”¹ä¸ºåœ¨ä¸»çº¿ç¨‹è·å–ï¼Œå…·ä½“å¯æŸ¥çœ‹demo;

#####attribute((constructor))å’ŒC++å¯¹è±¡é™æ€åˆå§‹åŒ–

__attribute__æ˜¯GNU Cç‰¹è‰²çš„ä¸€ä¸ªç¼–è¯‘å™¨å±æ€§ï¼Œå¯ä»¥é€šè¿‡iOS [attribute](http://www.narutoyq.cc/ios-attribute/)äº†è§£ä¸€ä¸‹ï¼›å®ƒä¸load,main,initializeçš„è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š
>load -> attribute((constructor)) -> main -> initialize

å¥½äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¬¡å¯¹æ¯”ä¸‹è¿™ä¸¤ä¸ªä¸‰æ–¹åº“ï¼š 
![](https://user-gold-cdn.xitu.io/2019/7/22/16c18f6c234fded6?imageView2/0/w/1280/h/960/ignore-error/1)

|åº“ 	|static initializeè¯¯å·®|
|----|----|
|AppStartTime 	|30mså·¦å³|
|A4LoadMeasure 	|40mså·¦å³|

ç»Ÿè®¡ä¸‹æ¥ï¼Œå‰è€…æ•°æ®ç›¸å¯¹æ›´ç²¾ç¡®ä¸€ç‚¹ï¼Œæœ€ä¸»è¦çš„æ˜¯æ‰“å°äº†æ–¹æ³•æŒ‡é’ˆï¼›A4LoadMeasureç»Ÿè®¡çš„æ–¹æ¡ˆæˆ‘ä¸æ•¢è‹ŸåŒï¼Œåªæ˜¯åœ¨__attribute__((constructor))æ–¹æ³•ä½œç”¨åŸŸå‰åæ‰“ç‚¹å°±æ˜¯C++ Static Initializersç«¯æ‰€ç”¨æ—¶é—´ï¼Ÿè¿™æ³¢å„¿æ“ä½œçœ‹ä¸æ‡‚äº†ï¼›è·å–__mod_init_funcï¼ˆåˆå§‹åŒ–çš„å…¨å±€å‡½æ•°åœ°å€ï¼‰æ®µæ›´å€¼å¾—è®¤åŒï¼›
ç®€å•ä»‹ç»ä¸‹åˆå§‹åŒ–å‡½æ•°å¤§è‡´æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

>initializeMainExecutable -> ImageLoader::runInitializers -> ImageLoader::doInitialization -> ImageLoaderMachO::doModInitFunctions

æœ€åä¸€ä¸ªå‡½æ•°æ˜¯ä¸»è¦å¤„ç†çš„é€»è¾‘ï¼Œä¸‹é¢ğŸ‘‡é™„ä¸Šä»£ç ï¼š
```
//è¯¥å‡½æ•°ä¸»è¦è´Ÿè´£å¤„ç†__DATAä¸‹çš„__mod_init_func
void ImageLoaderMachO::doModInitFunctions(const LinkContext& context)
{
    if ( fHasInitializers ) {
        const uint32_t cmd_count = ((macho_header*)fMachOData)->ncmds;
        const struct load_command* const cmds = (struct load_command*)&fMachOData[sizeof(macho_header)];
        const struct load_command* cmd = cmds;
        for (uint32_t i = 0; i < cmd_count; ++i) {
            if ( cmd->cmd == LC_SEGMENT_COMMAND ) {
                const struct macho_segment_command* seg = (struct macho_segment_command*)cmd;
                const struct macho_section* const sectionsStart = (struct macho_section*)((char*)seg + sizeof(struct macho_segment_command));
                const struct macho_section* const sectionsEnd = &sectionsStart[seg->nsects];
                for (const struct macho_section* sect=sectionsStart; sect < sectionsEnd; ++sect) {
                    const uint8_t type = sect->flags & SECTION_TYPE;
                    if ( type == S_MOD_INIT_FUNC_POINTERS ) {
                        Initializer* inits = (Initializer*)(sect->addr + fSlide);
                        const size_t count = sect->size / sizeof(uintptr_t);
                        
                        for (size_t j=0; j < count; ++j) {
                            Initializer func = inits[j];
                            // <rdar://problem/8543820&9228031> verify initializers are in image
                            if ( ! this->containsAddress((void*)func) ) {
                                dyld::throwf("initializer function %p not in mapped image for %s\n", func, this->getPath());
                            }
                        
                            func(context.argc, context.argv, context.envp, context.apple, &context.programVars);
                        }
                    }
                }
            }
            cmd = (const struct load_command*)(((char*)cmd)+cmd->cmdsize);
        }
    }
}
```
è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜è¯´æ˜ä¸‹ï¼Œ[åŸæ–‡](https://www.jianshu.com/p/c14987eee107)ä¹Ÿæåˆ°äº†ï¼Œif ( ! this->containsAddress((void*)func) )è¿™ä¸ªåˆ¤æ–­å‡½æ•°åœ°å€æ˜¯å¦åœ¨å½“å‰imageçš„åœ°å€ç©ºé—´ä¸­ï¼Œç”±äºæˆ‘ä»¬æ˜¯åœ¨åŠ¨æ€åº“ä¸­åšå‡½æ•°åœ°å€æ›¿æ¢ï¼Œæ›¿æ¢åçš„å‡½æ•°åœ°å€éƒ½æ˜¯åŠ¨æ€åº“ä¸­çš„äº†ï¼Œæ²¡æœ‰åœ¨å…¶ä»– imageä¸­ï¼Œæ‰€ä»¥å½“å…¶ä»–imageæ‰§è¡Œåˆ°è¿™ä¸ªåˆ¤æ–­æ—¶ï¼Œå°±æŠ›å‡ºäº†å¼‚å¸¸ã€‚åœ¨demoå·¥ç¨‹ä¸­è¿™ä¸ªç°è±¡è¿˜ä¸æ˜æ˜¾ï¼Œå½“å·¥ç¨‹æ¶æ„å¤æ‚ä¸€äº›ï¼Œè¿™ä¸ªé—®é¢˜å°±æ¯”è¾ƒæ˜æ˜¾äº†ï¼›

#####å·¥ç¨‹è¯´æ˜
ç›®å‰å·¥ç¨‹å·²æ”¯æŒpodå¼•å…¥:
```
pod 'A0PreMainTime'

#******å­ç»„ä»¶å•ç‹¬å¼•å…¥***********
#pre-mainé˜¶æ®µè€—æ—¶æ£€æµ‹
pod 'A0PreMainTime/PreMainTime'
#ä¸šåŠ¡æ—¶é—´åº¦é‡
pod 'A0PreMainTime/TimeMonitor'
```
å…·ä½“è¯·æŸ¥çœ‹[A0PreMainTime](https://github.com/binzi56/A0PreMainTime)

##mainï¼ˆï¼‰å‡½æˆæ‰§è¡Œå
mainï¼ˆï¼‰æ‰§è¡Œåçš„é˜¶æ®µæ˜¯æŒ‡ï¼Œä»mainï¼ˆï¼‰æ‰§è¡Œå¼€å§‹åˆ°appDelegateçš„didFinishLaunchingWithOptionsæ–¹æ³•é‡Œé¦–å±æ¸²æŸ“ç›¸å…³æ–¹æ³•æ‰§è¡Œå®Œæˆã€‚

é¦–å±åˆå§‹åŒ–æ‰€éœ€é…ç½®æ–‡ä»¶çš„è¯»å†™æ“ä½œ
é¦–å±åˆ—è¡¨å¤§æ•°æ®çš„è¯»å–
é¦–å±æ¸²æŸ“çš„å¤§é‡è®¡ç®—

è¿™é‡Œæ›´åŠ ä¼˜åŒ–çš„å¼€å‘æ–¹å¼æ˜¯ç¡®å®šå“ªäº›æ˜¯é¦–å±æ¸²æŸ“å¿…è¦çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œå“ªäº›æ˜¯APPå¯åŠ¨å¿…è¦çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œè€Œé‚£äº›åªæ˜¯éœ€è¦åœ¨å¯¹åº”çš„åŠŸèƒ½å¼€å§‹æ˜¯æ‰éœ€è¦åˆå§‹åŒ–çš„ã€‚æ•´ç†å‡ºæ¥ä¹‹åï¼Œåˆ†åˆ«æ”¾åˆ°å¯¹åº”çš„é˜¶æ®µè¿›è¡Œåˆå§‹åŒ–

##é¦–å±æ¸²æŸ“å®Œæˆå
è¿™ä¸ªé˜¶æ®µå°±æ˜¯ä»æ¸²æŸ“å®Œæˆæ—¶å¼€å§‹ï¼Œåˆ°didFinishLaunchingWithOptions æ–¹æ³•ä½œç”¨åŸŸç»“æŸæ—¶ç»“æŸã€‚
è¿™ä¸ªé˜¶æ®µç”¨æˆ·å·²ç»å¯ä»¥çœ‹åˆ°Appçš„é¦–é¡µä¿¡æ¯äº†ï¼Œæ‰€ä»¥ä¼˜åŒ–çº§åˆ«æ”¾åœ¨æœ€åï¼Œä½†æ˜¯è€—æ—¶æ“ä½œè¿˜æ˜¯è¦ä¼˜å…ˆå¤„ç†ï¼Œä»¥å…å½±å“ç”¨æˆ·ä½“éªŒã€‚

##åŠŸèƒ½çº§åˆ«çš„å¯åŠ¨ä¼˜åŒ–
ä»mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œåè¿™ä¸ªé˜¶æ®µä¸‹æ‰‹ï¼Œä¼˜åŒ–çš„æ€è·¯æ˜¯mainï¼ˆï¼‰å‡½æ•°æ‰§è¡Œååˆ°é¦–å±æ¸²æŸ“å®Œæˆå‰åªå¤„ç†ä¸é¦–å±æ¸²æŸ“ç›¸å…³çš„æ“ä½œï¼Œéé¦–å±ä¸šåŠ¡çš„åˆå§‹åŒ–ï¼Œç›‘å¬æ³¨å†Œï¼Œé…ç½®æ–‡ä»¶è¯»å–ç­‰æ”¾åˆ°é¦–å±æ¸²æŸ“å®Œå±‚åå¤„ç†ã€‚

##æ–¹æ³•çº§åˆ«çš„ä¼˜åŒ–
æ£€æŸ¥é¦–å±æ¸²æŸ“å®Œæˆå‰ä¸»çº¿ç¨‹ä¸Šæœ‰å“ªäº›è€—æ—¶æ–¹æ³•ï¼Œå°†æ²¡å¿…è¦çš„è€—æ—¶æ–¹æ³•ä¹‹åæˆ–è€…å¼‚æ­¥æ‰§è¡Œã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè€—æ—¶è¾ƒé•¿çš„æ–¹æ³•ä¸»è¦å‘ç”Ÿåœ¨è®¡ç®—å¤§é‡æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå…·ä½“è¡¨ç°å°±æ˜¯åŠ è½½ï¼Œç¼–è¾‘ï¼Œå­˜å‚¨å›¾ç‰‡å’Œæ–‡ä»¶ç­‰èµ„æºã€‚
è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å¯ä»¥ç›‘æ§Appå¯åŠ¨é€Ÿåº¦ï¼š

å®šæ—¶æŠ“å–ä¸»çº¿ç¨‹ä¸Šæ–¹æ³•çš„è°ƒç”¨å †æ ˆï¼Œè®¡ç®—ä¸€æ®µæ—¶é—´é‡Œæ–¹æ³•çš„è€—æ—¶ã€‚ç±»ä¼¼Time profileçš„å®ç°ã€‚

å¯¹objc_msgSendæ–¹æ³•è¿›è¡Œhookæ“ä½œï¼Œæ¥æŒæ¡æ‰€æœ‰æ–¹æ³•çš„è€—æ—¶


##å‚è€ƒ

02 | App å¯åŠ¨é€Ÿåº¦æ€ä¹ˆåšä¼˜åŒ–ä¸ç›‘æ§?
æˆ´é“­

APPå¯åŠ¨æ—¶é—´ä¼˜åŒ–
https://juejin.im/post/5cb5988ee51d456e8c1d3c2d


iOSæ·±æ€ç¯‡ | å¯åŠ¨æ—¶é—´çš„åº¦é‡å’Œä¼˜åŒ–
https://juejin.im/post/5d357ea9f265da1b74023afb

##å­¦ä¹ 

[è®¡ç®— +load æ–¹æ³•çš„è€—æ—¶](https://link.juejin.im/?target=https%3A%2F%2Ftriplecc.github.io%2F2019%2F05%2F27%2F%25E8%25AE%25A1%25E7%25AE%2597load%25E8%2580%2597%25E6%2597%25B6%2F)

[å¦‚ä½•ç²¾ç¡®åº¦é‡ iOS App çš„å¯åŠ¨æ—¶é—´](https://link.juejin.im/?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2Fc14987eee107)

[Appå¯åŠ¨æ—¶é—´ä¼˜åŒ–](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FSunshineBrother%2FJHBlog%2Fblob%2Fmaster%2FiOS%25E7%259F%25A5%25E8%25AF%2586%25E7%2582%25B9%2FiOS%25E5%25A4%25A7%25E6%259D%2582%25E7%2583%25A9%2FAPP%25E5%2590%25AF%25E5%258A%25A8%25E4%25BC%2598%25E5%258C%2596%2FApp%25E5%2590%25AF%25E5%258A%25A8%25E6%2597%25B6%25E9%2597%25B4%25E4%25BC%2598%25E5%258C%2596.md)

[iOSå¯åŠ¨æ—¶é—´ä¼˜åŒ–](https://link.juejin.im/?target=http%3A%2F%2Fwww.code4app.com%2Fblog-865069-4028.html)

[æ‰‹æ·˜iOSæ€§èƒ½ä¼˜åŒ–æ¢ç´¢](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fizhangxb%2FGMTC%2Fblob%2Fmaster%2F%25E5%2585%25A8%25E7%2590%2583%25E7%25A7%25BB%25E5%258A%25A8%25E6%258A%2580%25E6%259C%25AF%25E5%25A4%25A7%25E4%25BC%259AGMTC%25202017%2520PPT%2F%25E6%2589%258B%25E6%25B7%2598iOS%25E6%2580%25A7%25E8%2583%25BD%25E4%25BC%2598%25E5%258C%2596%25E6%258E%25A2%25E7%25B4%25A2%2520.pdf)

[ç¾å›¢å¤–å–iOS Appå†·å¯åŠ¨æ²»ç†](https://link.juejin.im/?target=https%3A%2F%2Ftech.meituan.com%2F2018%2F12%2F06%2Fwaimai-ios-optimizing-startup.html)

##æ‰©å±•

[dyldè¯¦è§£](https://link.juejin.im/?target=https%3A%2F%2Fwww.dllhook.com%2Fpost%2F238.html)

[æäº¤åˆ°AppStoreé—®é¢˜ï¼šä¸æ”¯æŒçš„ä½“ç³»ç»“æ„x86](https://link.juejin.im/?target=http%3A%2F%2Flandcareweb.com%2Fquestions%2F1199%2Fti-jiao-dao-app-storewen-ti-bu-zhi-chi-de-ti-xi-jie-gou-x86)