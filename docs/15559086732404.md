# 第五章 传输层
p203-240

5.1 传输层提供的服务
5.1.1 传输层的功能
从通信和信息处理角度看，传输层向它上面的应用层提供通信服务，属于面向通信部分的最高层，同时也是用户功能中的最低层。传输层为不同主机上的进程提供了逻辑通信，网络层为不同主机提供了逻辑通信。
两个主机进行端到端通信时，只有主机的协议栈才有传输层和应用层，而路由器在转发分组时都只用到下三层的功能，即通信子网中没有传输层，传输层只存在于通信子网以外的主机中。
传输层功能：
1.提供进程间（端到端）的逻辑通信。
2.复用和分用。传输层的复用表示发送方的不同进程可以使用同一个传输层协议发送数据。分用指的是接收方的传输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程。（网络层的复用指的是发送方不同协议的数据都可以封装成IP数据报发出去，分用指的是接收方的网络层在剥去首部后把数据交付给响应额协议）
3.差错检测（首部和数据部分）。网络层只检查IP数据报的首部。
4.提供两种不同的传输协议，TCP和UDP。网络层无法同时提供两种协议，要么只提供面向连接的服务，如虚电路，要么只提供无连接服务，如数据报。

5.1.2 传输层的寻址与端口
1.端口的作用
端口号标识本计算机应用层中的各进程。
服务访问点SAP：数据链路层的SAP是MAC地址，网络层的SAP是IP地址，传输层的SAP是端口。
2.端口号
1.服务端使用的端口号。熟知端口号0~1023；登记端口号1024~49151。FTP21，Telnet23，SMTP25，DNS53，TFTP69，HTTP80，SNMP161。
2.客户端使用的端口号。数值为49152~65535。

3.套接字
网络中采用发送方和接收方的套接字组合来识别端点。套接字=（主机IP地址，端口号），唯一的识别了网络中的一个主机和其上的一个应用。

5.1.3 无连接服务与面向连接服务
见下文

5.2 UDP协议
5.2.1 UDP数据报
UDP做了传输协议能够做的最少工作，只在IP的数据报服务至上增加了两个最基本的服务：复用分用和差错检测。UDP的优点：
1.无需建立连接。
2.无连接状态。可以支持更多的活动客户机。
3.分组首部开销小。
4.应用层能更好地控制要发送的数据和发送时间。UDP没有拥塞控制，不会影响主机的发送效率。
UDP常用于一次性传输比较少量数据的网络应用，提供尽最大努力的交付，即不保证可靠交付，因此维护传输可靠性的工作需要用户在应用层完成。UDP面向报文，报文不可分割，是UDP数据报处理的最小单位。发送方UDP对应用层交下来的报文，在添加首部后就交给网络层，既不拆分，也不合并。接收方UDP对IP层交上来的UDP数据报，在去除首部后就原封不动地交给上层应用进程，一次交付一个完整的报文。

UDP首部格式
UDP数据报包含两个部分：UDP首部和用户数据。UDP首部有8个字节，由4个字段组成，每个字段2个字节，各字段意义：
1.源端口，需要对方回信时选用，不需要时全0
2.目的端口，交付报文必须用到
3.UDP数据报长度（包括首部和数据），最小值8（仅有首部）
4.校验和，检测UDP数据报传输中是否有错，有错就丢弃，该字段可选，可以全0代替。


5.2.2 UDP校验
计算校验和时，要在UDP数据报之前增加12个字节的伪首部，得到一个临时的UDP数据报。伪首部既不向下传递，也不向上提交，而是仅为了计算校验和。这样的校验和，既检查了UDP数据报，又对IP数据报的源IP地址和目的IP地址进行了校验。
伪首部的组成：4字节的源IP地址，4字节的目的IP地址，1字节的0，1字节的协议字段17，2字节的UDP长度。
校验过程：发送方首先把全0放入校验和字段并且添加伪首部。然后把UDP数据报堪称是由许多16位的字符串连接起来。若UDP数据报的数据部分不是偶数个字节，则要在数据末尾增加一个全0字节。接下来就按二进制反码计算出这些16位字的和。将此和的二进制反码写入校验和字段。接收方把收到的UDP数据报加上伪首部，必要时补上一个全0字节后，按二进制反码计算出这些16位字的和。当无差错时，其结果应全为1。否则就表明有差错出现，接收方就应该丢弃这个UDP数据报。

5.3 TCP协议
5.3.1 TCP协议特点
TCP是在不可靠的IP层之上实现的可靠的数据传输协议，主要解决传输的可靠性、有序、无丢失和不重复的问题。特点是：
1.TCP是面向连接的传输层协议。
2.每条TCP连接只能有两个端点，只能是点对点的。
3.TCP提供可靠的交付服务，保证传输的数据无差错、不丢失、不重复且有序。
4.TCP提供全双工通信，通信双方在任何时候都可以发送数据，为此两端都有发送缓存和接收缓存，用来临时存放双向通信的数据。发送缓存用来存放①准备发送的数据②已发送未被确认的数据。接收缓存用来存放①按序到达但尚未被接收应用程序读取②不按序到达的数据。
5.TCP是面向字节流的，虽然应用程序和TCP的交互是一次一个数据块，但TCP把应用程序交下来的数据仅看成是一连串的无结构的字节流。

加：TCP可靠性是依靠停止等待协议实现的。
无差错的情况；超时重传情况；确认丢失情况；确认迟到情况；

5.3.2 TCP报文段
TCP传送的数据单元称为报文段。一个TCP报文段分为TCP首部和TCP数据两部分。TCP报文段首部最短为20字节，后面有4N字节是根据需要而增加的选项，通常长度为4字节的整数倍。TCP报文段既可以用来运载数据，也可以用来建立、释放连接和应答。
报文段首部组成：
1.源端口和目的端口字段，各占2个字节
2.序号字段，占4字节，TCP面向字节流的，所以传送的数据流中的每一个字节都被编上了一个序号。需要字段的值是本报文段所发送的数据的第一个字节的序号。
3.确认号字段，沾4字节，是期望收到对方的下一个报文段的数据的第一个字节的序号。若确认号为N，表示到序号N-1为止的所有数据都已正确收到。
4.数据偏移（首部长度），占4个字节，指出TCP报文段的数据起始处距TCP报文段的起始处有多远。单位是4字节，因此字段值15表示TCP首部的长度为60字节。
5.保留字段，占6位，目前全0
6.紧急位URG，URG=1时，紧急指针字段有效，告诉系统此报文段中有紧急数据，应尽快发送。数据从第一个字节到紧急指针所指字节就是紧急数据。
7.确认位ACK，ACK=1时，确认号字段才有效
8.推送位PSH，接收TCP收到PSH=1的报文段，就尽快交付给应用进程，而不再等到整个缓存都填满后才向上交付
9.复位位RST，RST=1表示TCP连接中出现严重差错，必须释放连接，然后重新建立运输连接
10.同步位SYN，SYN=1表示这是一个连接请求或连接接收报文。当SYN=1，ACK=0是一个连接请求报文。对方同意连接，则在响应报文中使用SYN=1，ACK=1。
11.终止位FIN，用来释放一个连接，FIN=1表明发送方的数据已发送完毕，并要求释放传输连接
12.窗口字段，占2字节，指出现在允许对方发送的数据量，单位字节
13.校验和，占2字节，加上12字节的伪首部（把UDP伪首部第四个字段，即协议字段的17改为6，其他都一样）
14.紧急指针字段，占16位，指出在本报文段中紧急数据共有多少字节（紧急数据放在本报文段数据的最前面）
15.选项字段，长度可变，TCP最初只规定了一直选项，最大报文端长度MSS。MSS是TCP报文段中的数据字段的最大长度
16.填充字段，为了使整个首部长度是4字节的整数倍

5.3.3 TCP连接管理
TCP是面向连接的协议，每个TCP连接都有三个阶段：连接建立、数据传送和连接释放。
1.TCP连接的建立，三次握手
第一步：客户机TCP向服务器TCP发送一个连接请求报文，该报文不含应用层数据，首部SYN=1。另外客户机随机选择一个起始序号seq=x（连接请求报文不携带数据，但要消耗一个序号）。这时客户端进入SYN-SENT阶段。
第二步：服务器TCP收到请求报文后，如同意连接，就向客户机发回确认，并为该TCP连接分配TCP缓存和变量。确认报文中SYN=1，ACK=1，确认号字段为ack=x+1，并且服务器随机产生起始序号seq=y（确认报文不携带数据，但要消耗一个序号）。确认报文段也不包含应用层数据。服务端进入SYN-RCVD阶段。
第三步：当客户机收到确认报文后，还要向服务器给出确认，并且也要给该连接分配缓存和变量。这个报文中ACK=1，seq=x+1,确认号字段为ack=y+1。该报文可以携带数据，如果不携带则不消耗序号。客户端进入ESTABLISHED阶段，服务端收到该报文后也进入ESTABLISHED阶段。

2.TCP连接的释放，四次握手，任一方都可以提出关闭
第一步：客户机打算关闭连接，客户机TCP发送一个连接释放报文段，并停止发送数据，主动关闭TCP连接，该报文中FIN=1，seq=u(前面已发送数据最后一个字节的序号加1，FIN报文即使不携带数据也要消耗一个序号)。客户端进入FIN-WAIT-1阶段。
第二步：服务器收到连接释放报文段后，立即发出确认，ACK=1，确认号是ack=u+1,seq=v(前面以发送数据的最后一个自己的序号加1)。此时，从客户机到服务器这个方向的连接就释放了，TCP处于半关闭状态，服务器进入CLOSE-WAIT状态。但服务器若发送数据，客户机仍要接收，即从服务器到客户机这个方向的连接并未关闭。
第三步：若服务器已经没有要向客户机发送的数据，就通知TCP释放连接，发出FIN=1，ACK=1，seq=w,ack=u+1。服务端进入LAST-ACK状态。
第四步：客户机接收到连接释放报文段后，必须发出确认。在确认报文段中，ACK=1，seq=u+1,ack=w+1。此时TCP连接还没释放掉，必须经过时间等待计时器设置的时间2MSL后，才进入连接关闭状态。等待期间客户端出于TIME-WAIT阶段。等待结束后两段都进入CLOSED状态。
>思考为什么要等待2MSL？
第一，为了保证A发送的最后一个ACK报文能够到达B。这个ACK报文段有可能丢失，因而使处在LAST-ACK状态的B收不到对已发送的FIN+ACK报文段的确认。B会超时重传这个FIN+ACK报文段，而A就能在2MSL时间内收到这个重传的FIN+ACK报文段。如果A在TIME-WAIT状态不等待一段时间，而是在发送完ACK报文段后就立即释放连接，就无法收到B重传的FIN+ACK报文段，因而也不会再发送一次确认报文段。这样，B就无法按照正常的步骤进入CLOSED状态。 
第二，A在发送完ACK报文段后，再经过2MSL时间，就可以使本连接持续的时间所产生的所有报文段都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求的报文段。 

总结：
1.建立
①SYN=1，seq=x
②SYN=1，ACK=1，seq=y，ack=x+1
③ACK=1，seq=x+1,ack=y+1

2.释放
①FIN=1，seq=u
②ACK=1,seq=v,ack=u+1
③FIN=1,ACK=1,seq=w,ack=u+1
④ACK=1,seq=u+1,ack=w+1

5.3.4 TCP可靠传输
TCP使用校验、序号、确认和重传等机制来确保可靠传输。校验和UDP一致。
1.序号
TCP首部的序号字段用来保证数据能有效提交给应用层。TCP把数据看成是一个无结构但是有序的字节流，序号是建立在传送的字节流之上，而不是建立在报文段之上。为每一个字节都编上了一个序号。
2.确认
TCP首部的确认号是期望收到对方的下一个报文段的数据的第一个字节的序号。接收方收到一个报文后，会给发送方发一个带确认号的报文。发送方缓存区会继续存储那些已经发送但未收到确认的数据报，以便在需要的时候重传。
TCP默认采用累积确认，即只确认数据流中至第一个丢失字节为止的字节。例如收到了0-2和6-7的报文，没收到3-5的报文，此时接收方仍在等待字节3，因此接收方下一个报文的确认号是3.
3.重传
超时和冗余ACK会导致TCP对报文段进行重传。
1.超时
TCP每发送一个报文段，就对这个报文段设置一次计时器。只要计时器设置的重传时间到期但还没收到确认，就要重传这个一报文。
为了计算超时计时器的重传时间，TCP采用一种自适应算法，它记录一个报文段发出的时间，以及受到相应确认的时间，这两个时间之差叫做报文段的往返时间（Round-Trip-Time,RTT）。TCP保留了RTT的一个加权平均往返时间RTTs。第一次测量RTT样本时，RTTs=RTT。以后每测量一个新的RTT样本时，重新计算一次RTTs：新RTTs=(1-a)x（旧RTTs）+ a x (新RTT样本)。RFC2988建议a=0.125。显然超时计时器设置的超时重传时间RTO应略大于上面的出的加权平均往返时间RTTs。使用公式计算：RTO=RTTs+4xRTTD。RTTD是RTT的偏差的加权平均值。
2.冗余ACK
超时触发重传存在一个问题就是超时周期往往太长。TCP规定每当比期望序号大的失序报文段到达时，发送一个冗余ACK，指明下一个期待字节的序号。当发送方收到对同一个报文段的3个冗余ACK时，就可以认为跟在这个被确认报文段之后的报文段已经丢失。发送方可以立即对期望的报文进行重传。这种技术通常称为快速重传。

5.3.5 TCP流量控制
TCP提供了流量控制服务以消除发送方使接收方缓存溢出的可能性，因此可以说流量控制是一个速度匹配的服务（匹配发送方的发送速率与接收方的读取速率）。
TCP提供一种基于【滑动窗口协议】的流量控制机制。在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，这就是接收窗口rwnd，即调整TCP报文段首部中窗口的字段值，来限制发送方向网路注入报文的速率。同时发送方根据其对当前网络拥塞程度的估计而确定的窗口值，称为拥塞窗口cwnd，其大小与网络带宽和时延密切相关。

5.3.6 TCP拥塞控制
拥塞控制就是防止过多的数据注入网络中，这样可以使网络中的路由器或链路不至于过载。
拥塞控制和流量控制的区别。

为了更好地对传输层进行拥塞控制，标准定义了以下四种算法：慢开始、拥塞避免、快重传和快恢复。
发送方在确定发送报文段的速率时，既要根据接收方的接收能力，又要从全局考虑不要使网络发送拥塞。因此TCP协议要求发送方维护以下两个窗口：
1)接收窗口rwnd，接收方根据目前接收缓存大小所许诺的接收能力，反映了接收方的容量。由接收方通过其放在TCP报文首部的窗口字段通知对方。
2)拥塞窗口cwnd，发送方根据自己估算的网络拥塞程度而设置的窗口值，反映了网络当前的容量。只要网络没出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要出现拥塞，拥塞窗口就减小一点，以减少注入网络中的分组数。
发送窗口的上限值应当取较小的一个。

维护拥塞窗口的算法：
1.慢开始和拥塞避免
1）慢开始算法
TCP刚刚连接好，开始发送TCP报文段时，先令拥塞窗口cwnd=1，即一个最大报文段长度MSS。而在每收到一个对新的报文段的确认后，将cwnd加1，即增大一个MSS。用这样的方法逐步增大发送方的拥塞窗口cwnd，可以使分组注入到网络的速率更加合理。举例，A当前cwnd=2,向B发送数据时，每次可以发送两个报文，当今过一个RTT后，A收到B对刚才两个报文的确认，于是就把cwnd调整为4，下一次发送时可以一次发送4个报文段。
使用慢开始算法后，每经过一个RTT，拥塞窗口cwnd就会加倍，即呈指数形式增长。这样慢开始一直把拥塞窗口增大到一个规定的慢开始门限ssthresh，然后改用拥塞避免算法。
2）拥塞避免算法
发送端的拥塞窗口每经过一个往返时延RTT就增加一个MSS，而不是加倍，使cwnd线性缓慢增长（即加法增大），当出现一次超时（网络拥塞）时，则令慢开始门限ssthresh等于当前cwnd的一半（即乘法减小）。
cwnd<ssthresh，使用慢开始算法
cwnd>ssthresh,停止使用慢开始而改用拥塞避免算法
cwnd=ssthresh，即可慢开始，也可拥塞避免（通常做法）
3）网络拥塞处理
当网络出现拥塞时，无论在慢开始阶段还是拥塞避免阶段，只要发送方检测到超时发生（没按时收到确认，重传计时器超时），就要把慢开始门限ssthresh设置为出现超时时发送方cwnd的一半（但不能小于2）。然后把拥塞窗口重新设置为1，执行慢开始算法。目的是为了迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕。拥塞避免是指在拥塞避免阶段把拥塞窗口控制为线性增长，是网络不容易出现拥塞，但不能保证能避免拥塞的发生。


2.快重传和快恢复
快重传和快恢复是对慢开始和拥塞避免算法的改进。
1）快重传
在可靠传输中，快速重传使用冗余ACK来检测丢包的发生。同样，冗余ACK也用于网络拥塞的检测（丢包意味着拥塞）。快重传并非取消重传计时器，而是在某些情况下可更早地重传丢失的报文段。当发送方连续收到三个重复的ACK报文时，直接重传对方尚未收到的报文段，而不必等待报文段设置的重传计时器超时。
2）快恢复
快恢复算法原理：当发送端收到连续三个冗余ACK时，就执行乘法减小算法，把慢开始门限ssthresh设置为出现拥塞时发送方cwnd的一半。与慢开始不同之处是它把cwnd的值设置为慢开始门限ssthresh改变后的值（慢开始是设置为1），然后开始执行拥塞避免算法（加法增大），使拥塞窗口缓慢地线性增大。由于跳过了cwnd从1开始的慢开始过程，所以称为快恢复。

在流量控制中，发送方发送数据的量由接收方决定，而在拥塞控制中，由发送方自己通过奸恶网络状况而决定。事实上，慢开始、拥塞避免、快重传和快恢复几种算法应该是同时应用于拥塞控制机制之中，当发送方检测到超时的时候就采用慢开始和拥塞避免，当发送方接收到冗余ACK的时候就采用快重传和快恢复。

发送方发送窗口的实际大小由流量控制和拥塞控制共同决定，也就是rwnd和cwnd中较小的那个。