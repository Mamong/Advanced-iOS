# 点歌功能实现细节

整个点歌系统分为三个部分，一个是前端，也就是插件端；一个是后端接口层，作为前端和网易云音乐的中介者；另一个是网易云服务器。这里只介绍插件端。

插件的开发经历了几个阶段：第一个阶段是点歌基本可用，第二个阶段是完善可用性，第三个阶段是添加私人FM，第四个阶段是交互完善。

第一个阶段中的点歌流程如下：
1.用户发送含有点歌两个字的文本，系统提示用户已进入点歌模式，发送歌曲名进行搜索。
2.用户发送歌曲名称后，给出最多20条搜索结果，每条搜索结果带有序号，并提示用户发送选择的歌曲序号。搜索结果可能会超过单条消息的长度限制，这时候将歌单做成直播间背景图代替。
3.用户发送序号后获取歌曲播放地址，播放对应歌曲。
4.存在搜索结果的情况下，用户可以再次发送序号进行歌曲切换。发送不合法序号，会提示序号不合法。发送非序号数据，会提示输入不正确，猜测用户是要发送‘搜歌’或者‘退出’。
5.用户发送‘搜歌’后，提示用户发送歌曲名称进行搜索。
6.用户可以自行发送‘退出’，退出点歌模式。系统会在进入点歌模式后80秒强制用户退出点歌模式。

以上流程实现的基本模式是状态转移。每种指令会切换到特定的状态，每种状态下有特定的输入。但是有几个明显的缺陷，一个是搜索不能随时进行，需要发送'搜歌'后才能搜索一次。另一个是延时强制用户退出用的是dispath_after这种偷懒的做法，需要在退出前检查当前用户是不是dispath_after捕获的用户，否则会把后面的用户过早踢掉。但是这种检查会产生误伤，假如A用户点歌后主动退出，B用户也如此，当A再次点歌时候，可能会被他上次触发的延迟退出机制过早踢掉。

第二阶段主要增加搜索结果翻页功能，增加了房名修改为正在播放歌曲的功能，改进了搜索流程，改进提示消息。

为了简化搜索以及时时搜索，改进了搜索模式。通过发送‘歌曲名称/’搜索歌曲，发送‘歌手//’搜索歌手。因为后缀的存在，这样就区分了指令和搜索内容。这样搜索不必在特定的状态下才能进行。作为指令系统，用户往往更容易接受简单但啰嗦的指令，使用中发现，用户更易接受，发送‘搜歌’后搜索内容这种一开始就深入人心的简单但略显啰嗦的方式。但是为了更好的扩展性，需要用户迁移使用习惯。而且目前的设计是后缀法，用户可能输完搜索内容才想起要加个东西，如果使用前缀法，就要移动光标，体验就会差很多。

不管是自己的房间还是别人的房间，都能修改标题和背景图，是一个没有检验操作用户id的bug。

当有用户处于点歌模式时，其他用户可能也会发起点歌申请，第一阶段会忽略此类情况。这个阶段根据用户反馈，增加了诸如”某某正在点歌，某某请等待“的提示，更加友好的提示。

由于背景图经常上传失败，一些长歌单的搜索结果可能就看不到，但是经验告诉我们，搜索结果的第0条往往是你想要的。因此提示用户”如果背景图没有及时更新，请发送0“。

第三阶段加入了私人FM功能。在此之前听歌都需要点歌，播完了就没了。有时候只是想随便听听，不想自己点歌，这时候FM就派上用场了。私人FM接口每请求一次，会给你2，3首不重复的歌曲。FM和点歌共享同一个播放器，但是不能和它发生竞争。它的使用逻辑是，它可以在点歌模式下随时打开和关闭。打开的时候不会导致点播的歌曲被打断。FM歌曲会被点播打断，用户点播请求需要被优先处理。当用户的歌曲播放完成后，FM歌曲就要恢复播放，并且要恢复进度。也就意味着FM被打断时，需要保存播放进度。

由于需要知道歌曲是否播放完成，而播放器只提供了歌曲长度和进度的信息。这时候通过开启一个定时器，定期执行一些任务。例如检查歌曲长度和当前进度之差是否小于800毫秒，如果是的话，就认为播放完全了。对于少数差值超过800毫秒但小于1500毫秒的情况，通过比较本次进度和上次进度是否一致来判断是否播放完全。点播播放完全，则根据FM是暂停还是未启用来确定下一步行为。