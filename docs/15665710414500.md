21.TweakåŸç†&é˜²æŠ¤.md

[TOC]

##ä¿®æ”¹ç³»ç»Ÿåº”ç”¨
ç›®æ ‡ï¼šæ¶ˆé™¤å¯¹æ‰‹æœºæ¡Œé¢çš„æé†’æ°”æ³¡


* é€šè¿‡cycriptåˆ†ææ°”æ³¡
  * è¿æ¥æ‰‹æœºå¹¶ç™»é™†ï¼Œé€šè¿‡è¿›ç¨‹åˆ—è¡¨æŒ‡ä»¤ps -AæŸ¥çœ‹springboardåœ¨ç³»ç»Ÿçš„è·¯å¾„ï¼Œå¾—åˆ°ç»“æœï¼šSystem/Library/CoreServices/SpringBoard.app/SpringBoardï¼Œåœ¨è¯¥ç›®å½•ä¸‹æ‰¾åˆ°springboardçš„machoæ–‡ä»¶ï¼ˆæœªè¿›è¡ŒåŠ å¯†ï¼‰ï¼Œ
  * ç»ˆç«¯è¿›è¡ŒMacæ¡Œé¢ï¼Œå°†ä¸Šè¿°MachOæ‹·è´è‡³æ¡Œé¢ï¼Œå¯ä»¥ä½¿ç”¨IFunBoxå’ŒæŒ‡ä»¤ï¼ŒæŒ‡ä»¤ï¼š$scp -r -P 12345 root@localhost:/System/Library/CoreServices/SpringBoard.app/SpringBoard ~/Desktopï¼Œé€šè¿‡file SpringBoardæŒ‡ä»¤ç¡®è®¤SpringBoard: Mach-O 64-bit executable arm64ï¼Œé€šè¿‡otool -l SpringBoard | grep cæŸ¥çœ‹åŠ å¯†ä¿¡æ¯ï¼Œå¹¶æœªæŸ¥æ‰¾åˆ°cryptå­—æ®µï¼›
  * é€šè¿‡class-dumpå¯¼å‡ºSpringBoardçš„å¤´æ–‡ä»¶ï¼›
  * è¿›å…¥springboardåº”ç”¨è¿›ç¨‹cycript -p SpringBoardï¼Œåœ¨cyç¯å¢ƒä¸­å¯¼å…¥è‡ªå®šä¹‰cyæ–‡ä»¶@import cmdsï¼Œè·å–å½“å‰çš„VCï¼Œé€’å½’æ‰“å°é¡µé¢å…ƒç´ ï¼Œå¹¶æœªæ‰¾åˆ°ç›¸å…³å¯ç–‘è§†å›¾ã€‚
  * å‘ä¸‹ä¸€å“åº”è€…æ¨è¿›ï¼Œæ‰“å°KeyWindowçš„è§†å›¾å±‚çº§ï¼Œæ‰¾åˆ°å¯ç–‘ç±»å‹ï¼šSBIconViewï¼ŒSBIconParallaxBadgeViewï¼Œé€šè¿‡å¯¹è§†å›¾è¿›è¡Œéšè—æ˜¾ç¤ºæ“ä½œå¯ä»¥å¾—åˆ°SBIconParallaxBadgeViewå³æ˜¯æ°”æ³¡è§†å›¾ç±»ï¼›

* ç¼–å†™Tweakä»£ç 
  * åˆ›å»ºTweakå·¥ç¨‹ï¼ŒæŒ‡å®šå·¥ç¨‹åã€åŒ…åã€ä½œè€…åã€ä¾é™„è¿›ç¨‹APPIDï¼›
  * é…ç½®Tweakå®‰è£…åœ°å€å’Œç«¯å£ï¼šTHEOS_DEVICE_IPï¼ŒTHEOS_DEVICE_PORT;
  * æŸ¥çœ‹SBIconParallaxBadgeViewå¤´æ–‡ä»¶å¯çŸ¥ï¼Œå…¶å†…éƒ¨å®ç°äº†-initæ–¹æ³•ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡æš´åŠ›æ–¹å¼å¯¹-initè¿›è¡Œhookï¼Œå¹¶è¿”å›nilï¼›
  * å¯¹å·¥ç¨‹æ‰§è¡Œmakeã€make packageã€make installï¼Œå°†æ’ä»¶å®‰è£…åˆ°æ‰‹æœºé‡æ–°SpringBoardå³å¯å°†æ°”æ³¡æ¶ˆå¤±ï¼›

åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼ŒspringBoardçš„KeyWindowå¯èƒ½éšç€é”å±ä¹‹ç±»çš„æ“ä½œï¼Œå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦åœ¨è°ƒè¯•æ“ä½œä¸­æœ‰å…¶ä»–é¡µé¢å‡ºç°ã€‚

Tweakåœ¨æ¯æ¬¡ç¼–è¯‘åéƒ½ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªå®‰è£…åŒ…ï¼Œç‰ˆæœ¬ä¹Ÿä¼šéšä¹‹å¢åŠ ï¼Œå½“ä½ç‰ˆæœ¬è¦†ç›–é«˜ç‰ˆæœ¬æ—¶å®‰è£…å°†ä¼šæŠ¥é”™ã€‚


##TweakåŸç†
###å·¥ä½œæ­¥éª¤
1. é€šè¿‡Theoså·¥å…·åˆ›å»ºä¸€ä¸ªTweaké¡¹ç›®ï¼Œåœ¨é¡¹ç›®ä¸­ç¼–å†™logosä»£ç ï¼›
2. ä»£ç å®Œæˆåï¼Œé€šè¿‡makeå·¥å…·å°†.xmæ–‡ä»¶ç¼–è¯‘ç”Ÿæˆç›®æ ‡åŠ¨æ€åº“æ–‡ä»¶:./.theos/obj/debug/xxx.dylibï¼›
3. é€šè¿‡make packageæŒ‡ä»¤å¯¹xxx.dylibä»¥åŠxxx.plistè¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆ.debåŒ…ï¼›
4. é€šè¿‡make installå°†.debæ‹·è´åˆ°æ‰‹æœºå¹¶è¿›è¡Œè§£å‹ï¼Œå°† xxx.dylibæ‹·è´åˆ° /Library/MobileSubstrate/DynamicLibrariesè·¯å¾„ä¸‹ï¼Œå®Œæˆå®‰è£…ï¼›
5. é‡å¯Springboardç¨‹åºï¼Œé™„åŠ xxx.plistæ‰€æŒ‡å‘çš„è¿›ç¨‹è¿›è¡Œhookï¼›

###åŸç†å³ç”Ÿæ•ˆè¿‡ç¨‹
åœ¨å°†æ’ä»¶å®‰è£…åˆ°æ‰‹æœºåï¼Œé‡å¯Springboardåï¼Œå†æ¬¡å¯åŠ¨hookçš„ç›®æ ‡ç¨‹åºCydiaå°†æ‰«æDynamicLibrariesç›®å½•ä¸‹çš„pliståˆ—è¡¨ï¼Œå¦‚æœé‡å¯çš„ç¨‹åºçš„åŒ…ååŒ…å«åœ¨pliståˆ—è¡¨ä¸­ï¼Œé‚£ä¹ˆå°†é€šè¿‡DYLD_INSERT_LIBRIRESæ–¹å¼å°†åŠ¨æ€åº“ä¾é™„åˆ°ç›®æ ‡ç¨‹åºä¸Šï¼Œç„¶åé€šè¿‡hookåŠŸèƒ½å°†åŸæ–¹æ³•é‡æ–°æŒ‡å‘åˆ°hookæ–¹æ³•ä¸Šã€‚

å¤§è‡´æµç¨‹ï¼ˆä»å®‰è£…æ’ä»¶åï¼‰ï¼šDYLD_INSERT_LIBRIRES ---->fishhook/method_swlizzeï¼›

å®ä¾‹ï¼š1. å†™ä¸€ä¸ªæ­£å‘å°targetç¨‹åºåœ¨touchBegin:ä¸­æ‰“å°ä¸€å¥è¯ï¼Œè¿è¡Œå·¥ç¨‹ï¼Œ2. ç„¶åæ–°å»ºä¸€ä¸ªdylibçš„å·¥ç¨‹ï¼Œåœ¨+loadæ–¹æ³•ä¸­å¯¹touchBeginæ–¹æ³•è¿›è¡ŒmethodSwlizzeï¼Œæ‰“å°å¦å¤–ä¸€å¥è¯ï¼Œ3. å°†dylibæ‹·è´åˆ°æ‰‹æœºï¼Œé€šè¿‡DYLD_INSERT_LIBRIRESå°†dylibä¾é™„åˆ°targetè¿›ç¨‹ï¼Œå†æ¬¡ç‚¹å‡»ï¼Œ4. æŸ¥çœ‹å‰å2æ¬¡çš„å·®åˆ«ã€‚

##DYLD_INSERT_LIBRARIESæºç åˆ†æ
DYLDæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œåº”ç”¨ç¨‹åºï¼Œä»–çš„æºç è‹¹æœå¼€æºå…¬å¸ƒåœ¨ï¼š[Source Code](https://opensource.apple.com/tarballs/dyld/)ã€‚
æ–‡ç« [é˜²æ­¢tweakä¾é™„ï¼ŒAppæœ‰é«˜æ‹›ï¼›ç ´è§£Appä¿æŠ¤ï¼Œtweakç•™ä¸€æ‰‹ä¸­](http://bbs.iosre.com/t/tweak-app-app-tweak/438)ï¼ŒæåŠçš„ç¾å›¢èƒ½å¤Ÿå¼ºåŠ›é˜»æ­¢å„ç§dylibçš„æ³¨å…¥ï¼Œä½¿å¾—ä¸€åˆ‡tweakå‡ä¸ºç‹—æ¯”ã€‚å…¶é˜²æ­¢æ³¨å…¥çš„æ–¹å¼åœ¨DYLDçš„æºç ä¸­èƒ½æ‰¾åˆ°ç›¸åº”çš„ä½“ç°ã€‚
é˜…è¯»æºç åï¼Œåˆ†æDYLDçš„åŠ è½½æµç¨‹ï¼šåœ¨dyld-519.2.2ç‰ˆä¸­ï¼Œ

1.åœ¨5906è¡Œå¼€å§‹ï¼ŒåŠ è½½ä»»ä½•åº“
```
// load any inserted libraries
if   ( sEnv.DYLD_INSERT_LIBRARIES != NULL ) {
    for (const char* const* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != NULL; ++lib) 
        loadInsertedDylib(*lib);
}
```
2.åœ¨ç¬¬ä¸€æ­¥å‰çš„è¿˜æœ‰ä¸€ä¸ªæ§åˆ¶æµç¨‹ï¼Œåœ¨5691è¡Œï¼š
```
if ( gLinkContext.processIsRestricted ) {
    pruneEnvironmentVariables(envp, &apple);
    // set again because envp and apple may have changed or moved
    setContext(mainExecutableMH, argc, argv, envp, apple);
}    
```
è¯¥åˆ¤æ–­ä¼šæ ¹æ®gLinkContext.processIsRestrictedä¸­çš„å€¼å†³å®šæ˜¯å¦ç»§ç»­åŠ è½½åŠ¨æ€åº“å†…å®¹ã€‚

3.è€Œæ§åˆ¶gLinkContext.processIsRestrictedæ˜¯å¦ä¸ºçœŸçš„è¯­å¥ï¼Œåœ¨4696è¡Œï¼š
```
if ( issetugid() || hasRestrictedSegment(mainExecutableMH) ) {
 gLinkContext.processIsRestricted = true;
}
```
è¯¥éƒ¨åˆ†è¡¨æ˜ï¼Œissetugid() || hasRestrictedSegment(mainExecutableMH)å…¶ä¸­ä¸€ä¸ªä¸ºçœŸå³å¯æ»¡è¶³æ¡ä»¶ï¼Œè€Œä¸Šæ¶çš„åº”ç”¨ä¸­issetugid()æ˜¯ç¦æ­¢ä½¿ç”¨çš„ï¼Œæ‰€ä»¥hasRestrictedSegmentå˜å¾—å…³é”®ã€‚

4.é€šè¿‡æœç´¢hasRestrictedSegmentå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼Œç¬¬4293è¡Œï¼š
```
static bool hasRestrictedSegment(const macho_header* mh)
{
    const uint32_t cmd_count = mh->ncmds;
    const struct load_command* const cmds = (struct load_command*)(((char*)mh)+sizeof(macho_header));
    const struct load_command* cmd = cmds;
    for (uint32_t i = 0; i < cmd_count; ++i) {
        switch (cmd->cmd) {
            case LC_SEGMENT_COMMAND:
            {
                const struct macho_segment_command* seg = (struct macho_segment_command*)cmd;
                
                //dyld::log("seg name: %s\n", seg->segname);
                if (strcmp(seg->segname, "__RESTRICT") == 0) {
                    const struct macho_section* const sectionsStart = (struct macho_section*)((char*)seg + sizeof(struct macho_segment_command));
                    const struct macho_section* const sectionsEnd = &sectionsStart[seg->nsects];
                    for (const struct macho_section* sect=sectionsStart; sect < sectionsEnd; ++sect) {
                        if (strcmp(sect->sectname, "__restrict") == 0) 
                            return true;
                    }
                }
            }
            break;
        }
        cmd = (const struct load_command*)(((char*)cmd)+cmd->cmdsize);
    }
        
    return false;
}
```
è¯¥å‡½æ•°è¡¨æ˜ï¼Œåªè¦machoæ–‡ä»¶çš„Headerä¸­æœ‰åä¸º__RESTRICTçš„Segmentæ®µã€ä¸”è¯¥æ®µæœ‰åä¸º__restrictçš„sectionsï¼Œåˆ™machoå°±ä¼šé˜»æ­¢è¿›ç¨‹çš„ä¾é™„ã€‚

##ä¿®æ”¹RESTRICTæ®µé˜²æŠ¤æ³¨å…¥
ä¸ºå·¥ç¨‹çš„Other Link Flagsæ·»åŠ  -Wl -seccreate __RESTRICT __restrict /dev/nullå†…å®¹å³å¯åœ¨machoä¸­æ·»åŠ  __RESTRICT __restrictï¼Œå³å¯ä»¥ä½¿hasRestrictedSegmentå‡½æ•°çš„è¿”å›å€¼ä¸ºtrueï¼Œä»è€Œè¾¾åˆ°é˜²æ­¢Tweakçš„æ³¨å…¥é—®é¢˜ã€‚
![](https://upload-images.jianshu.io/upload_images/9181395-e589ea157ab75804.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/608)

ä½†æ˜¯æµ‹è¯•æ—¶å‘ç°ï¼Œæ·»åŠ äº†è¯¥æ®µæ•°æ®åï¼Œåœ¨è‡ªå·±å·¥ç¨‹ä¸­æ·»åŠ å…³è”çš„åŠ¨æ€åº“å¥½åƒä¹Ÿæ²¡æ³•æ­£å¸¸åœ¨æ³¨å…¥äº†ã€‚æ‰€ä»¥å°†ä¾èµ–åº“çš„MachOTypeä¿®æ”¹ä¸ºStatic Libraryï¼Œä¹Ÿæ˜¯æ­£å¸¸åŠ è½½ã€‚
![](https://upload-images.jianshu.io/upload_images/9181395-f16d52dddc7afb33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000)

å®ä¾‹ï¼šç¼–å†™ä¸€ä¸ªTweaké¡¹ç›®ï¼Œå®‰è£…åˆ°è¶Šç‹±æ‰‹æœºï¼ŒæŸ¥çœ‹Tweakæ˜¯å¦ä¾é™„æˆåŠŸã€‚

##ç ´åé˜²æŠ¤
åˆ©ç”¨äºŒè¿›åˆ¶ä¿®æ”¹å™¨å°†MachOä¸­çš„__restrictè¿›è¡Œç¯¡æ”¹ï¼Œç¯¡æ”¹åAPPä½¿ç”¨MonkeyDevè¿›è¡Œé‡ç­¾åï¼Œå°±å¯ä»¥å†æ¬¡å¯¹è¿›ç¨‹è¿›è¡ŒåŠ¨æ€åº“æ³¨å…¥ä¾é™„äº†ã€‚

##åˆ©ç”¨æºç é˜²æ­¢MachOè¢«ä¿®æ”¹
å°†Macå¹³å°çš„hasRestrictedSegmentå‡½æ•°æ‹·è´å‡ºæ¥ï¼Œåœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¯¥å‡½æ•°æ¥åˆ¤æ–­æŒ‡å®šæ®µå†…å®¹æ˜¯å¦ä¸æœŸæœ›å€¼ä¸€è‡´ï¼Œå¦åˆ™è¡¨ç¤ºMachOå·²ç»è¢«ä¿®æ”¹äº†ã€‚

åœ¨æ‹·è´å‡ºæ¥çš„ä»£ç ä¸­ä¼šæœ‰å¾ˆå¤šæœªå®šä¹‰çš„å¤´æ–‡ä»¶ï¼Œéœ€è¦å¯¼å…¥<mach-o/loader.h>ã€<mach-o/dyld.h>ã€‚

åœ¨loaderä¸­æœ‰mach_header[_64]çš„ç»“æ„ä½“ï¼Œè¡¨ç¤º32ã€64ä½çš„machoçš„Headerã€‚åœ¨dyldä¸­æœ‰mach_header* _dyld_get_image_header(uint32_t image_index) å‡½æ•°ï¼Œè¯¥å‡½æ•°é€šè¿‡indexè·å–æŒ‡å®šmachoçš„Headerï¼Œå½“ä¼ å…¥indexä¸º0æ—¶å³æ˜¯å½“å‰å¯åŠ¨çš„Appçš„å¯æ‰§è¡Œç¨‹åºï¼ˆDYLDå¯åŠ¨Appæ—¶ï¼Œé¦–å…ˆåŠ è½½çš„æ˜¯Appçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¯ä»¥é€šè¿‡LLDBï¼šimage listæŒ‡ä»¤æŸ¥çœ‹è„šæ ‡è¿›è¡ŒéªŒè¯ï¼‰ï¼‰ã€‚

å¯¼å…¥å¤´æ–‡ä»¶åéœ€è¦å¯¹éƒ¨åˆ†å®å®šä¹‰è¿›è¡Œå®šä¹‰ï¼Œä»dyld.cppæ–‡ä»¶ä¸­å¯ä»¥æ‹·è´å‡ºæ¥ï¼ŒåŒ…æ‹¬LC_SEGMENT_COMMANDå’Œmach_header[_64]ç­‰ã€‚

å°†è¯¥å‡½æ•°è°ƒè¯•å®Œæˆåï¼Œå°±å¯ä»¥åœ¨+loadä¸­è¿›è¡Œè°ƒç”¨å¹¶ä¼ å…¥_dyld_get_image_headerè·å–çš„macho_headerï¼ŒéªŒè¯å½“å‰machoçš„æ®µå†…å®¹æ˜¯å¦ä¸æœŸæœ›çš„å†…å®¹ä¸€è‡´ã€‚

##æ€»ç»“

æ”»ï¼šä¸€èˆ¬è£¸å¥”ç¯å¢ƒä¸­å¯ä»¥ä½¿ç”¨DYLD_INSERT_LIBRARIESè¿›è¡ŒåŠ¨æ€åº“ä¸´æ—¶æ³¨å…¥ï¼›
é˜²ï¼šé€šè¿‡æ·»åŠ __RESTRICTæ®µå¯ä»¥èµ·åˆ°é˜²æŠ¤è¿›ç¨‹ä¾é™„çš„é—®é¢˜ï¼›
æ”»ï¼šå¯¹åŠ æœ‰__RESTRICTå­—æ®µçš„é˜²å¾¡æ‰‹æ®µï¼Œé€šè¿‡äºŒè¿›åˆ¶ä¿®æ”¹è¯¥å­—æ®µçš„å†…å®¹å¹¶è¿›è¡Œä»£ç é‡ç­¾åå°±å¯ä»¥åšåˆ°å†æ¬¡ä¾é™„çš„æ•ˆæœï¼Œå¦‚monkeyDevã€‚
é˜²ï¼šä½¿ç”¨DYLDä¸­hasRestrictedSegmentå‡½æ•°å¯¹machoä¸­çš„__RESTRICTå†…å®¹è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœä¸é¢„æœŸå€¼ä¸åŒå°±å¯ä»¥ä¸»åŠ¨é€€å‡ºåº”ç”¨ã€‚

##èŠ±çµ®
###å…³äºldid

å¯¹ldidçš„æè¿°ï¼šä¸ºæ‰§è¡Œæ–‡ä»¶æ·»åŠ ç­¾åï¼Œä»¥ä¾¿åœ¨æ‰‹æœºä¸Šè¿›è¡Œè¿è¡Œï¼Œåœ¨æ“ä½œkeychain_dumperæ—¶å‡ºç°killed:9çš„é—®é¢˜çš„ä¿®å¤ï¼Œå‚è§ï¼š[iPhone: keychain dumper â€“ killed 9 problem](http://www.securitylearn.net/2012/01/21/iphone-keychain-dumper-killed-9-problem/)ï¼Œå…¶ä¸­çš„é‡ç‚¹æ˜¯ï¼š
```
On the newer versions of iOS (v5) running this tool ends up with killed 9 error.

The problem here is iOS kernel signature checks the binary file at several places. Jailbreak tools cannot patch all these signature checks because it is difficult for them to patch each and every signature check. When we copy keychaindumper to iPhone, it does not have a signature. So running the binary exits with killed 9 message because iOS kernel does not have the signature of keychain_dumper.

To get rid of this problem add the signature of keychain_dumper to kernel cache (list of hashes) by running the below command. After adding the signature, you can run the rest of commands to dump the keychain entries.

ldid -S keychain_dumper
```

###TweakåŸç†å…¶ä»–è§£é‡Š

[iOSé€†å‘ä¹‹äºŒ-ä¸€ä¸ªç®€å•çš„Tweakæ’ä»¶åŸç†è§£æ](https://blog.csdn.net/zhangyutangde/article/details/78339134)ï¼šé‡ç‚¹
1.è¾“å…¥é¡¹ç›®åç§°ã€é¡¹ç›®åŒ…åï¼Œä½œè€…ï¼Œéœ€è¦æ³¨å…¥çš„å®¿ä¸»ç¨‹åºåŒ…åå’Œå®¿ä¸»è¿›ç¨‹åç§°
```
Project Name (required): FirstReProj        #é¡¹ç›®å
Package Name [com.yourcompany.firstreproj]: com.zyt.firstreproj        #é¡¹ç›®åŒ…å
Author/Maintainer Name [aron]: zyt        #ä½œè€…
[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: com.apple.springboard        #éœ€è¦æ³¨å…¥çš„å®¿ä¸»ç¨‹åºåŒ…å
[iphone/tweak] List of applications to terminate upon installation (space-separated, '-' for none) [SpringBoard]: SpringBoard        #å®¿ä¸»è¿›ç¨‹åç§°
Instantiating iphone/tweak in firstreproj/...
Done.
```
2.å·¥ç¨‹ç›®å½•ï¼š
```
FirstReProj.plist    - æ³¨å…¥çš„å®¿ä¸»ç¨‹åºåŒ…åé…ç½®æ–‡ä»¶ 
Makefile    -makeæ–‡ä»¶ 
Tweak.xm    -æºç æ–‡ä»¶ï¼Œxmæ ¼å¼æ–‡ä»¶æ”¯æŒc/oc/logoè¯­æ³•ï¼Œxæ ¼å¼æ”¯æŒlogoè¯­æ³• 
control    -æ§åˆ¶æ–‡ä»¶ï¼Œä¿å­˜é¡¹ç›®çš„é…ç½®ä¿¡æ¯
```
3.åŸç†ï¼š
```
(1) Cydia Substrate è¶Šç‹±æœºå™¨æ’ä»¶ã€è½¯ä»¶è¿è¡Œçš„åŸºç¡€ä¾èµ–åŒ…ï¼Œæä¾›åŠ¨æ€æ³¨å…¥çš„åŠŸèƒ½ Sbustrate ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šMobileHookerï¼ŒMobileLoaderï¼Œsafe mode

(1.1) MobileHooker ç”¨äºæ›¿æ¢ç³»ç»Ÿçš„æ–¹æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºHooking
æœ‰ä¸¤ä¸ªæœ‰ Cydia Substrate æ¡†æ¶æä¾›çš„æ–¹æ³•

MSHookMessageEx ç”¨äºæ³¨å…¥OCå‡½æ•°
å‡½æ•°åŸå‹ void MSHookMessageEx(Class _class, SEL message, IMP hook, IMP *old)

MSHookFunction ç”¨äºæ³¨å…¥c/c++å‡½æ•°

Logosè¯­æ³•ä¸­çš„ %hook å°±æ˜¯å¯¹æ­¤å‡½æ•°çš„å°è£…ï¼Œä»£ç æ›´ç®€æ´ã€ç›´è§‚

(1.2) MobileLoader
å°†tweakæ’ä»¶æ³¨å…¥åˆ°ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºä¸­ï¼ˆåŠ¨æ€æ³¨å…¥ï¼šptraceï¼‰
MobileLoader æŸ¥æ‰¾ /Library/MobileSubstrate/DynamicLibraries ä¸‹ plist æ–‡ä»¶æŒ‡å®šçš„ä½œç”¨èŒƒå›´ï¼ŒæŠŠå¯¹åº”çš„dylibåŠ¨æ€çš„æ³¨å…¥åˆ°è¿›ç¨‹ä¸­

safe mode : ä¸åŠ è½½ç¬¬ä¸‰æ–¹é©±åŠ¨ï¼ŒåªåŠ è½½ç³»ç»Ÿè‡ªå¸¦çš„é©±åŠ¨
å®‰è£…äº†ç¬¬ä¸‰æ–¹æ’ä»¶å¯¼è‡´ç³»ç»Ÿçš„åœ¨å¯åŠ¨çš„æ—¶å€™å¯¼è‡´æ¡Œé¢çš„å´©æºƒï¼Œä¼šå¯åŠ¨ safe modeï¼Œä¸ä¼šé‡æ–°åŠ è½½æ¡Œé¢
*å¯ä»¥sshåˆ°iPhoneï¼Œä½¿ç”¨dpkgå‘½ä»¤åˆ é™¤Tweakæ’ä»¶åŒ…

dpkg -r com.zyt.reapp 
```
4.DEBåŒ…è§£æ
ä½¿ç”¨make package ä¼šåœ¨é¡¹ç›®ç›®å½•ä¸‹é¢ç”Ÿæˆpackageæ–‡ä»¶å¤¹ï¼Œé‡Œé¢åŒ…å«äº†debåŒ…ï¼Œ DEBåŒ…æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§ç‰¹æ®Šæ ¼å¼çš„å‹ç¼©åŒ…ï¼Œè§£å‹é‡Œé¢çš„å†…å®¹,å¯ä»¥çœ‹åˆ°Libraryçš„ç›®å½•ç»“æ„å’Œå®‰è£…åˆ°iPhoneä¸Šå¯¹åº”æ–‡ä»¶ç›®å½•ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œæ˜¯ä¸€ç§æ˜ å°„å…³ç³»ï¼Œç®€å•æ¥è¯´ï¼Œå®‰è£…debåŒ…å°±æ˜¯ä¸€ä¸ªè§£å‹æ“ä½œè€Œå·²ï¼ŒæŠŠdebåŒ…ä¸­çš„å†…å®¹è§£å‹åˆ°iPhoneå°±å®Œæˆäº†å®‰è£…æµç¨‹ã€‚

###å‘çˆ¹çš„æ‰“å°

ä¸‹é¢è¿™æ®µlogosæˆªå›¾çš„æºç åœ¨è¢«æˆ‘å¤åˆ¶åˆ°mdä¹‹å‰è¢«æˆ‘æŠ˜è…¾äº†ä¸€ä¸ªå°æ—¶ã€‚ä¸€ç›´æŠ¥é”™<compose failure [invalid utf8]>ï¼Œå°±æ˜¯æ‰“å°ä¸å‡ºæ¥ã€‚

æºç æˆªå›¾ï¼š
![](https://upload-images.jianshu.io/upload_images/9181395-ab74df41d00ebb3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000)

ä»æˆªå›¾çœ‹ä¸Šå»æ²¡æœ‰ä¸€ç‚¹é—®é¢˜ï¼Œåªè¦æœ‰å’Œæ‰“å°åè·Ÿçš„å†…å®¹éƒ½æ‰“å°ä¸æ¥ï¼Œæ¯”å¦‚å°è¯•äº†æ‰“å°æ²¡ã€æ‰“å°äº†éƒ½æ‰“å°ä¸å‡ºæ¥ï¼Œæœ¬æ¥æƒ³è®°ä¸€ä¸‹logosä¸­æ˜¯ä¸æ˜¯å¥‡è‘©å¾—ä¸æ”¯æŒæ‰“å°è¿™ä¸ªä¸­æ–‡ç¬¦å·ï¼Œç»“æœå¤åˆ¶ç²˜è´´åˆ°.mdæ‰å‘ç°ä¸‹é¢çš„é—®é¢˜ã€‚

æºç å¦‚ä¸‹ï¼š
```
#import <UIKit/UIKit.h>
%hook ViewController
- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
    // NSLog(@"biabsdï¼š%@", @"æ‰“æ‰“åˆ†");
    // NSLog(@"sdfrieï¼š%@", @"è¢«hookåæ‰“å°æ²¡æœ‰ç‚¹åˆ°æˆ‘ï¼Œè¢«hookäº†");
    // NSLog(@"å½“å‰è¾“å…¥å¯†ç ï¼š");
    // NSLog(@"å½“å‰è¾“å…¥å¯†ç ï¼š%@", touches);

    NSLog(@"æ‰“å°äº†");
    // %orig;
}
%end
```
![](https://upload-images.jianshu.io/upload_images/9181395-49e313886e21feb0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000)

åœ¨å¤åˆ¶åˆ°.mdä¸­æ‰å‘ç°æœ‰ä¸€çº¢ç‚¹ï¼Œè¾“å…¥æ³•æ˜¯æ²¡æ³•æ‰“å‡ºæ¥çš„ï¼Œç®€ä¹¦ä¹Ÿæ²¡æ˜¾ç¤ºå‡ºæ¥ã€‚é‚£è¿™ä¸ªçº¢ç‚¹æ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ
è¿™æ®µæ–‡å­—æœ¬æ¥æ˜¯è¢«æ”¾åœ¨xibçš„label.textä¸­çš„ï¼Œåœ¨æ‰“å°åé¢æ•´å¥½ç”¨alt+enterå¼ºè¡Œæ¢äº†è¡Œï¼Œç»“æœç²˜è´´è¿‡æ¥çš„æ—¶å€™æ ¼å¼ä¾ç„¶è¿˜åœ¨ï¼Œä½†æ˜¯sublimeå´æ²¡æ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œæ˜¯åœ¨ä¸€è¡Œä¸­ï¼Œå½“ç„¶.md ä¹Ÿæ²¡ä¹Ÿæ¢è¡Œæ˜¾ç¤ºã€‚ã€‚ã€‚å°±è¿™æ ·ä¸€ç›´ç”¨äº†ä¸€ä¸ªå°æ—¶æ‰è§‰å¾—æ˜¯logoså¥‡è‘©ä¸æ”¯æŒæ‰“å°è¿™æ ·çš„ä¸­æ–‡ç¬¦ï¼Œç»“æœæ˜¯æœ‰ç‰¹æ®Šçš„æ¢è¡Œç¬¦ï¼ŒNSLogä¸æ”¯æŒè¿™æ ·çš„ç‰¹æ®Šæ¢è¡Œç¬¦ã€‚ã€‚ã€‚ã€‚
æ³ªå¥”å•Šï¼Œï¼Œ-_-||ğŸ˜‚ğŸ˜‚


##è½¬è½½
ä½œè€…ï¼š_é¡º_1896
é“¾æ¥ï¼šhttps://www.jianshu.com/p/6dff204eff0a
æ¥æºï¼šç®€ä¹¦
ç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒå¹¶æ³¨æ˜å‡ºå¤„ã€‚