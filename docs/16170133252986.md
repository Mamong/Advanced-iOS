Combine æ¡†æ¶ï¼Œä»0åˆ°1 â€”â€” 4.Foundationä¸­çš„publisher

[TOC]

## å‰è¨€

 

KVO([Key-Value Observing](Using Key-Value Observing in Swift)) æ˜¯è‹¹æœå¼€å‘è€…å¸¸ç”¨çš„åŠŸèƒ½ï¼Œå¾ˆå¤šæ¡†æ¶éƒ½ä¼šä½¿ç”¨ KVO æ¥å‘é€å¼‚æ­¥æ”¹åŠ¨ã€‚å°†åŸºäºå›è°ƒå’Œé—­åŒ…çš„ KVO ä»£ç è¿ç§»åˆ° Combineï¼Œå¯ä»¥ä½¿ä½ çš„ä»£ç æ›´ä¼˜é›…ã€æ›´æ˜“ç»´æŠ¤ã€‚

 
## ç”¨ KVO ç›‘æ§æ”¹åŠ¨


åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œ UserInfo ç±»å‹ä¸ºå®ƒçš„ lastLogin å±æ€§æä¾›äº† KVO æ”¯æŒã€‚ç¤ºä¾‹ä»£ç åœ¨ viewDidLoad() æ–¹æ³•ä¸­è°ƒç”¨äº† observe(_:options:changeHandler:) æ–¹æ³•æ¥åˆ›å»ºäº†ä¸€ä¸ªå¤„ç†è¿™ä¸ªå±æ€§çš„å˜åŠ¨çš„é—­åŒ…ã€‚è¿™ä¸ªé—­åŒ…æ¥æ”¶ä¸€ä¸ªæè¿°äº†æ”¹åŠ¨äº‹ä»¶çš„ NSKeyValueObservedChange å¯¹è±¡ï¼Œå¹¶ä»è¿™ä¸ªå¯¹è±¡å–å‡ºäº† newValue å±æ€§çš„å€¼ï¼Œç„¶åæ‰“å°ã€‚

æ¥ä¸‹æ¥ï¼Œç¤ºä¾‹ä»£ç åœ¨ viewDidAppear(_:) æ–¹æ³•ä¸­æ”¹äº† lastLogin å±æ€§çš„å€¼ï¼Œæœ€ç»ˆè§¦å‘äº†é—­åŒ…å¹¶æ‰“å°äº†æ¶ˆæ¯ã€‚

```
class UserInfo: NSObject {
    @objc dynamic var lastLogin: Date = Date(timeIntervalSince1970: 0)
}

@objc var userInfo = UserInfo()
var observation: NSKeyValueObservation?

override func viewDidLoad() {
    super.viewDidLoad()
    observation = observe(\.userInfo.lastLogin, options: [.new]) { object, change in
        print ("lastLogin now \(change.newValue!).")
    }
}

override func viewDidAppear(_ animated: Bool) {
    super.viewDidAppear(animated)
    userInfo.lastLogin = Date()
}
```

## å°† KVO ä»£ç è¿ç§»åˆ° Combine
æƒ³è¦è¿ç§» KVO ä»£ç åˆ° Combineï¼Œåªéœ€æ›¿æ¢ observe(_:options:changeHandler:) æ–¹æ³•ä¸º NSObject.KeyValueObservingPublisherã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨çˆ¶å¯¹è±¡(parent object)ä¸Šè°ƒç”¨ publisher(for:) æ–¹æ³•æ¥è·å¾—æ­¤å‘å¸ƒè€…çš„å®ä¾‹ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹çš„ viewDidLoad() æ–¹æ³•æ‰€ç¤ºï¼š
```
class UserInfo: NSObject {
    @objc dynamic var lastLogin: Date = Date(timeIntervalSince1970: 0)
}

@objc var userInfo = UserInfo()
var cancellable: Cancellable?

override func viewDidLoad() {
    super.viewDidLoad()
    cancellable = userInfo.publisher(for: \.lastLogin)
        .sink() { date in print ("lastLogin now \(date).") }
}

override func viewDidAppear(_ animated: Bool) {
    super.viewDidAppear(animated)
    userInfo.lastLogin = Date()
}
```

KVOå‘å¸ƒè€… ä¼šç”Ÿæˆè§‚å¯Ÿç±»å‹çš„å…ƒç´ ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º Dateï¼‰ï¼Œè€Œä¸æ˜¯ NSKeyValueObservedChangeã€‚è¿™æ ·å°±èŠ‚çœäº†ä¸€æ­¥æ“ä½œï¼Œå› ä¸ºä½ ä¸å¿…åƒå‰ä¸€ä¸ªç¤ºä¾‹ä¸­é‚£æ ·ä» change å¯¹è±¡ä¸­è·å– newValueã€‚

 
æ€»ç»“

 

å¦‚æœä¸Šé¢çš„ç¤ºä¾‹å˜å¾—æ›´åŠ å¤æ‚ï¼Œä¼ ç»Ÿçš„ KVO ä»£ç å¯èƒ½ä¼šå˜å¾—éå¸¸è‡ƒè‚¿ï¼Œè€ŒåŸºäº Combine çš„ KVO ä»£ç å¯ä»¥åˆ©ç”¨å„ç§æ“ä½œç¬¦è¿›è¡Œé“¾å¼è°ƒç”¨ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥è®©ä»£ç æ›´ä¼˜é›…ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„æ˜“è¯»æ€§ã€‚å¯¹äºä»¥åç»´æŠ¤è¿™æ®µä»£ç çš„äººæ¥è¯´ï¼Œè¿™å°†æ˜¯ä¸€ç§è¾›ç¦çš„æ„Ÿè§‰~ ğŸ˜‰

æœ‹å‹ï¼Œè¡ŒåŠ¨èµ·æ¥å§ï¼æŠŠç°æœ‰é¡¹ç›®ä¸­çš„æ—§ä»£ç é‡æ„æˆä½¿ç”¨ Combine çš„ä»£ç ~

ä½œè€…ï¼šFicowShen
é“¾æ¥ï¼šhttps://www.jianshu.com/p/578d3080bfae
æ¥æºï¼šç®€ä¹¦
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚